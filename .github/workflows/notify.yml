name: MESS Notifications

on:
  push:
    paths:
      # V1: flat yaml files
      - 'exchange/state=received/*.yaml'
      - 'exchange/state=received/*.yml'
      # V2: directory-based threads
      - 'exchange/state=received/**/*.yaml'
      - 'exchange/state=received/**/*.yml'
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'Run in test mode (no actual notifications)'
        required: false
        default: 'false'
        type: boolean

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: scripts/notify
        run: npm ci

      - name: Process notifications
        working-directory: scripts/notify
        env:
          # Notification service credentials (configure in repo settings)
          PUSHOVER_APP_TOKEN: ${{ secrets.PUSHOVER_APP_TOKEN }}
          TWILIO_ACCOUNT_SID: ${{ secrets.TWILIO_ACCOUNT_SID }}
          TWILIO_AUTH_TOKEN: ${{ secrets.TWILIO_AUTH_TOKEN }}
          TWILIO_FROM_NUMBER: ${{ secrets.TWILIO_FROM_NUMBER }}
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
          SENDGRID_FROM_EMAIL: ${{ secrets.SENDGRID_FROM_EMAIL }}
          GMAIL_EMAIL: ${{ secrets.GMAIL_EMAIL }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          # Google Tasks OAuth credentials
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          GOOGLE_REFRESH_TOKEN: ${{ secrets.GOOGLE_REFRESH_TOKEN }}
          # Client URL - defaults to template's hosted client
          CLIENT_URL: ${{ secrets.CLIENT_URL }}
          GITHUB_REPO: ${{ github.repository }}
        run: node index.js ${{ inputs.test_mode == 'true' && '--dry-run' || '' }}
